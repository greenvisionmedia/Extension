const g=e=>document.getElementById(e),pmDownloaded=new Event("pm-downloaded"),pmLogin=new Event("pm-login"),pmComplete=new Event("pm-complete");function waitFor(e,t,s){let a=setInterval((()=>{let s=document.querySelector(e);s&&(clearInterval(a),t(s))}),s)}function injectModal(e){e.insertAdjacentHTML("beforeBegin",'<div id="modal-button"><svg aria-hidden="true" focusable="false" width="17" height="17" viewBox="0 0 17 19"><path d="M12.6,19.2c-4.1-2.2-7.7-5.2-11.1-8.3,0,0-1.5-1.4-1.5-1.4C3.1,6.2,6.3,3,9.7,0c2.6,2.8,5.2,5.9,7.4,9.1-2,1.5-4,2.9-6.3,4,1-1.9,2.2-3.6,3.4-5.3v1.9c-2.2-1.6-4.3-3.5-6.3-5.3,0,0,3,0,3,0-2.1,2.2-4.3,4.3-6.5,6.4v-3c3.1,3.5,6,7.1,8.1,11.3h0Z"></path></svg></div>'),pm=document.createElement("dialog"),pm.id="pm",pm.innerHTML='<div class="pm-menu"><h1 class="pm-title">GV Publish</h1><div id="exit" class="pm-exit"><div></div><div></div></div></div><div id="page-1" class="pm-page show-state"><p class="pm-subtitle login_subtitle">Login to GV Publish</p><div class="pm-container"><label for="username" class="pm-label">GV Publish Username</label><div class="pm-text-row"><input type="text" id="username" class="pm-text" placeholder="Username"></div><label for="password" class="pm-label">GV Publish Password</label><div class="pm-text-row"><input type="password" id="password" class="pm-text" placeholder="Password"></div><button type="button" id="login" class="pm-button">Login</button></div></div><div id="page-2" class="pm-page show-state"><p class="pm-subtitle" focusable="false">Your site will be published to <a href="#" rel="noopener" id="site" class="pm-link"><span>#</span><svg width="11" height="11"><path fill="currentColor" d="M5 1v1h3.293L4.646 5.646l.707.707L9 2.707V6h1V1H5zm2 8H2V4h2V3H2c-.55 0-1 .45-1 1v5c0 .55.45 1 1 1h5c.55 0 1-.45 1-1V7H7v2z"></path></svg></a></p><div class="pm-container"><div class="pm-button-row"><button type="button" id="cancel" class="pm-button">Cancel</button> <button type="button" id="publish" class="pm-button">Publish to green servers!</button></div></div><div id="settings" class="pm-settings"><svg aria-hidden="true" focusable="false" width="16" height="16" viewBox="0 0 16 16" class="bem-Svg" style="display: block;"><path d="M6 12l.01-3V7L6 4l4 4-4 4z" fill="currentColor"></path></svg> Advanced options</div><form id="form" class="pm-form pm-container open-state"><div class="pm-text-row"><label for="domain" class="pm-label is-domain">Release domain</label> <input id="domain" type="text" class="pm-text" placeholder="i.e. greenvision.media"> <label for="site-code" class="pm-label is-site-code">Site code</label> <input id="site-code" type="text" class="pm-text" placeholder="i.e. gv"></div><label for="scripts" class="pm-label">Add scripts (comma separated list)</label> <input id="scripts" type="text" class="pm-text show-state on"> <label for="staging" class="pm-label">Publish destination</label><div class="pm-button-row"><input type="button" id="staging" class="pm-button pressed-state on" value="Staging"> <input type="button" id="release" class="pm-button pressed-state" value="Release"></div><button type="button" id="save" class="pm-button show-state on">Save</button> <button type="button" id="restart" class="pm-button show-state">Configured</button></form></div><div id="page-3" class="pm-page show-state"><div class="pm-container"><div id="drop-area" class="pm-drop-area drag-state"><label id="upload-label" class="show-state"><input id="upload" type="file" accept=".zip"></label> <svg id="file" class="show-state" aria-hidden="true" focusable="false" viewBox="0 0 20 20" width="40" height="40" style="margin-top: -8px"><path fill-rule="evenodd" clip-rule="evenodd" d="M5 3a1 1 0 00-1 1v12a1 1 0 001 1h10a1 1 0 001-1V8l-5-5H5zm5 1H9v6h6V9l-5-5z" fill="currentColor"></path></svg> <svg id="loading" class="show-state on" viewBox="0 0 30 30" width="32" height="32" stroke="#ebebeb" fill="none" fill-rule="evenodd" stroke-width="3"><g transform="translate(2 2)"><g transform="rotate(0)"><circle stroke-opacity=".3" cx="13" cy="13" r="13"></circle><path d="M 13 0 A 13 13 0 0 0 0 13"></path><animateTransform attributeName="transform" begin="0s" dur="1s" type="rotate" from="0 13 13" to="360 13 13" repeatCount="indefinite"></animateTransform></g></g></svg> <svg id="complete" class="show-state" aria-hidden="true" focusable="false" viewBox="0 0 30 30" width="32" height="32"><circle fill="#b3bc7e" cx="14.5" cy="14.5" r="14.5"/><path fill="#4e6a57" d="M21.43,9.18c-1.93,4.63-5.25,8.52-8.68,12.1,0,0-1.32-1.26-1.32-1.26-1.27-1.21-2.38-2.64-3.18-4.24-.27-.56-.52-1.14-.69-1.82,.69,.11,1.29,.31,1.87,.54,1.66,.66,3.17,1.65,4.49,2.82,0,0-2.6,.11-2.6,.11,2.93-3.2,6.21-6.23,10.1-8.24h0Z"/></svg><p id="drop-text" class="pm-subtitle show-state on">Downloading your files...</p><p id="link" class="pm-subtitle show-state">Published! <a href="#" rel="noopener" class="pm-link">Go to site<svg width="11" height="11"><path fill="currentColor" d="M5 1v1h3.293L4.646 5.646l.707.707L9 2.707V6h1V1H5zm2 8H2V4h2V3H2c-.55 0-1 .45-1 1v5c0 .55.45 1 1 1h5c.55 0 1-.45 1-1V7H7v2z"></path></svg></a></p></div></div></div>',document.body.appendChild(pm);const t={modal:pm,modalButton:g("modal-button"),exit:g("exit"),page1:g("page-1"),page2:g("page-2"),page3:g("page-3"),login:g("login"),username:g("username"),password:g("password"),cancel:g("cancel"),publish:g("publish"),settings:g("settings"),form:g("form"),save:g("save"),restart:g("restart"),site:g("site"),inputs:{domain:g("domain"),siteCode:g("site-code"),release:g("release"),staging:g("staging"),scripts:g("scripts")},dropArea:g("drop-area"),dropText:g("drop-text"),link:g("link"),upload:g("upload"),uploadLabel:g("upload-label"),icons:{file:g("file"),loading:g("loading"),complete:g("complete")}};resetUI(t),configureUI(t),t.modalButton.addEventListener("click",(e=>{e.preventDefault,t.modal.showModal()})),t.exit.addEventListener("click",(e=>{e.preventDefault,t.modal.classList.add("close"),setTimeout((()=>{t.modal.classList.remove("close"),t.modal.close(),resetUI(t)}),100)})),t.login.addEventListener("click",(e=>{e.preventDefault,sendLogin(t)})),document.addEventListener("pm-login",(e=>{t.page1.classList.remove("on"),t.page2.classList.add("on")})),t.cancel.addEventListener("click",(e=>{t.modal.classList.add("close"),setTimeout((()=>{t.modal.classList.remove("close"),t.modal.close(),resetUI(t)}),100)})),t.settings.addEventListener("click",(e=>{e.preventDefault,t.settings.classList.toggle("on"),t.form.classList.toggle("on")})),t.inputs.staging.addEventListener("click",(e=>{e.preventDefault,t.inputs.release.classList.remove("on"),t.inputs.staging.classList.add("on")})),t.inputs.release.addEventListener("click",(e=>{e.preventDefault,t.inputs.release.classList.add("on"),t.inputs.staging.classList.remove("on")})),t.save.addEventListener("click",(e=>{e.preventDefault,setConfigData(t)})),t.restart.addEventListener("mouseenter",(e=>{e.preventDefault,t.restart.innerHTML="Restart"})),t.restart.addEventListener("mouseleave",(e=>{e.preventDefault,t.restart.innerHTML="Configured"})),t.restart.addEventListener("click",(e=>{e.preventDefault,Object.values(t.inputs).forEach((e=>{e.disabled=!1})),t.save.classList.add("on"),t.restart.classList.remove("on"),g("script-row").remove()})),t.publish.addEventListener("click",(s=>{t.page2.classList.remove("on"),t.page3.classList.add("on"),automateDownload(e)})),document.addEventListener("pm-downloaded",(()=>{t.icons.loading.classList.remove("on"),t.icons.file.classList.add("on"),t.uploadLabel.classList.add("on"),t.dropText.innerHTML="Drag your folder here, or click to upload"})),t.dropArea.addEventListener("dragenter",(e=>{e.preventDefault,t.dropArea.classList.add("on")})),t.dropArea.addEventListener("dragover",(e=>{e.preventDefault,t.dropArea.classList.add("on")})),t.dropArea.addEventListener("dragleave",(e=>{e.preventDefault,t.dropArea.classList.remove("on")})),t.dropArea.addEventListener("drop",(e=>{e.preventDefault,t.icons.file.classList.remove("on"),t.icons.loading.classList.add("on"),t.uploadLabel.classList.remove("on"),t.dropArea.classList.remove("on"),t.dropText.innerHTML="Publishing your files...",sendData(e.dataTransfer)})),t.upload.addEventListener("change",(e=>{e.preventDefault,t.icons.file.classList.remove("on"),t.icons.loading.classList.add("on"),t.uploadLabel.classList.remove("on"),t.dropText.innerHTML="Publishing your files...",sendData(this.files)})),document.addEventListener("pm-complete",(()=>{t.icons.loading.classList.remove("on"),t.icons.complete.classList.add("on"),t.dropText.classList.remove("on"),t.link.classList.add("on")}))}function resetUI(e){chrome.storage.local.get(["PROJECT","DOMAIN","SITE_CODE","STAGING","SCRIPTS","LOGIN_STATE"],(t=>{e.inputs.domain.value=t.DOMAIN,e.inputs.siteCode.value=t.SITECODE,e.inputs.scripts.value=t.SCRIPTS.join(", "),t.STAGING?(e.inputs.staging.classList.add("on"),e.inputs.release.classList.remove("on")):(e.inputs.staging.classList.remove("on"),e.inputs.release.classList.add("on")),!1===t.LOGIN_STATE?(e.page1.classList.add("on"),e.page2.classList.remove("on")):(e.page2.classList.add("on"),e.page1.classList.remove("on")),e.page3.classList.remove("on")})),e.icons.file.classList.remove("on"),e.icons.loading.classList.add("on"),e.icons.complete.classList.remove("on"),e.settings.classList.remove("on"),e.form.classList.remove("on"),e.link.classList.remove("on"),e.dropText.classList.add("on"),e.uploadLabel.classList.remove("on"),e.dropText.innerHTML="Downloading your files..."}function configureUI(e){chrome.storage.local.get(["PROJECT","DOMAIN","SITE_CODE","STAGING","SCRIPTS","CONFIG_STATE"],(t=>{if(t.CONFIG_STATE){e.inputs.domain.value=t.DOMAIN,e.inputs.siteCode.value=t.SITE_CODE,e.inputs.scripts.value=t.SCRIPTS.join(", "),t.STAGING?(e.inputs.staging.classList.add("on"),e.inputs.release.classList.remove("on"),e.link.setAttribute("href",`https:// ${t.SITE_CODE}.greenvisionmedia.net`),e.site.setAttribute("href",`https:// ${t.SITE_CODE}.greenvisionmedia.net`),e.site.querySelector("span").innerHTML=t.SITECODE+".greenvisionmedia.net"):(e.inputs.staging.classList.remove("on"),e.inputs.release.classList.add("on"),e.link.setAttribute("href",`https:// ${t.DOMAIN}`),e.site.setAttribute("href",`https:// ${t.DOMAIN}`),e.site.querySelector("span").innerHTML=t.DOMAIN);let s=document.createElement("div");for(script of(s.id="script-row",s.classList.add("pm-text"),e.inputs.scripts.insertAdjacentElement("afterend",s),t.SCRIPTS)){let e=document.createElement("span");e.innerHTML=script,s.appendChild(e)}Object.values(e.inputs).forEach((e=>{e.disabled=!0})),e.save.classList.remove("on"),e.restart.classList.add("on")}}))}function setConfigData(e){let t=!0;t=!!e.inputs.staging.classList.contains("on");const s=window.location.pathname.split("/")[2];let a=e.inputs.scripts.value.split(", ");chrome.storage.local.set({PROJECT:s,DOMAIN:e.inputs.domain.value,SITECODE:e.inputs.siteCode.value,SCRIPTS:a,STAGING:t,CONFIGSTATE:!0}).then(configureUI(e))}function sendLogin(e){let t={username:e.username.value,password:e.password.value};t.username&&t.password?fetch("http://localhost:5555/api/v1/login",{method:"POST",body:t}).then((()=>{chrome.storage.local.set({LOGIN_STATE:!0}),document.dispatchEvent(pmLogin)})).catch((e=>{console.log(e)})):alert("Enter a username and password")}function sendData(e){let t=new FormData;chrome.storage.local.get(["PROJECT","DOMAIN","SITE_CODE","STAGING","SCRIPTS"],(s=>{t.append("file",e),t.append("config-data",s),fetch("http://localhost:5555/api/v1/config",{method:"POST",body:t}).then((()=>{document.dispatchEvent(pmComplete)})).catch((e=>{console.log(e)}))}))}function automateDownload(e){e.click();let t='div[style="display: flex; justify-content: space-between; flex: 0 1 auto;"]';waitFor(t+" button:nth-child(4)",(e=>{e.click(),waitFor(t+' a[href^="blob:"]',(e=>{e.click(),document.dispatchEvent(pmDownloaded),document.querySelector(t+" button:nth-child(3)").click()}),10)}),10)}function injectMeter(e){e.insertAdjacentHTML("beforeEnd",'<div class="pm-meter"><div><span id="meter">Xg </span><span>CO<sub>2</sub></span></div></div>');let t=g("meter");const s=new co2.co2;document.addEventListener("pm-complete",(()=>{let e=chrome.storage.local.get("DOWNLOAD_SIZE");t.innerHTML=s.perByte(e)}))}waitFor(".bem-TopBar_Body_ExportButton",injectModal,1e3),waitFor(".bem-TopBar_Body_Group-left",injectMeter,1e3);const TYPE_HTML="text/html",TYPE_PLAIN="text/plain",svgRegex=/^<\?xml version="1.0" encoding="UTF-8"\?>\s*/;function getEmbedInput(e){e.addEventListener("click",pasteSVG),e.addEventListener("copy",pasteSVG),e.addEventListener("focus",pasteSVG),waitFor(".w-codemirror",getEmbedInput,1e3)}async function minifySVG(e){return e.replace(svgRegex,"").replace(/(?:<defs>(?:[\s\S]*)<\/defs>\n)/,"").replace(/(?:id="(?:.+)"\s)/g,"").replace(/(?:class="(?:.+)"\s)/g,"")}async function pasteSVG(){const e=await navigator.clipboard.readText();if(svgRegex.test(e)){const t=await minifySVG(e);await navigator.clipboard.writeText(t)}}waitFor(".w-codemirror",getEmbedInput,1e3);const markdownRegex=/^@markdown\s*/,markdownStringNoNewLine="@markdown";function getRichTextInput(e){const t=e.parentElement.querySelector("div.bem-Field_Head");if(!t)return;const s=t.querySelector("div.bem-View");if(!s)return;s.classList.add("mp-container"),e.addEventListener("click",pasteMarkdown),e.addEventListener("copy",pasteMarkdown),e.addEventListener("focus",pasteMarkdown);const a=document.createElement("div");a.innerHTML='When pasting Markdown, make sure the contents start with <span class="mp-chip">@markdown</span> on its own line. <a class="mp-link" href="https://greenvision.media/docs/build-process/" target="_blank">Learn More</a>',a.classList.add("mp-info"),s.appendChild(a)}async function formatMarkdownToHTML(e){const t=e.replace(/\u00A0\//g," ").replace(markdownRegex,"");return markdown(t)}async function HTMLtoClipboard(e){const t=new Blob([e],{type:TYPE_HTML}),s=[new ClipboardItem({[TYPE_HTML]:t})];await navigator.clipboard.write(s)}async function pasteMarkdown(){const e=await navigator.clipboard.read();for(const t of e)for(const e of t.types){const s=await t.getType(e),a=await s.text();if(e===TYPE_PLAIN&&markdownRegex.test(a)){const e=await formatMarkdownToHTML(a);await HTMLtoClipboard(e)}else if(e===TYPE_HTML){const e=(new DOMParser).parseFromString(a,TYPE_HTML).querySelector("body");if(!e.textContent.startsWith("@markdown"))return;let t=[];if(e.children.length>=2)t=Array.from(e.children);else{if(!(1===e.children.length&&"div"===e.children[0].tagName.toLowerCase()&&e.children[0].children.length>=2))return;t=Array.from(e.children[0].children)}t=t.filter((e=>"meta"!==e.tagName.toLowerCase())).slice(1);const s=[];for(let e=0;e<t.length;e++){const a=t[e];let n;const i=a.tagName.toLowerCase();n="p"===i||"div"===i?await formatMarkdownToHTML(a.textContent):a.outerHTML,s.push(n)}if(0===s.length)return;await HTMLtoClipboard(s.join("\n"))}}}waitFor(".bem-RichTextInput",getRichTextInput,1e3);